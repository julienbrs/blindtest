# Ralph Progress Log
# This file is append-only. Ralph adds entries after each completed issue.

=== Issue 1.1: Initialiser le projet Next.js ===
Timestamp: 2026-01-17T16:05:00Z
Status: COMPLETED
Commit: 65da864
Notes: Initialized Next.js 16.1.3 project with TypeScript, App Router, Tailwind CSS, and ESLint using create-next-app. Project runs successfully with npm run dev.
Files: package.json, tsconfig.json, next.config.ts, eslint.config.mjs, postcss.config.mjs, .gitignore, src/app/layout.tsx, src/app/page.tsx, src/app/globals.css

=== Issue 1.2: Configurer Tailwind CSS ===
Timestamp: 2026-01-17T16:10:00Z
Status: COMPLETED
Commit: ac49b60
Notes: Created tailwind.config.ts with content paths and theme extend structure. Added @config directive to globals.css for Tailwind v4. Build verified successful.
Files: tailwind.config.ts, src/app/globals.css

=== Issue 1.3: Définir la palette de couleurs festive ===
Timestamp: 2026-01-17T16:15:00Z
Status: COMPLETED
Commit: 81aa841
Notes: Added festive color palette with primary (magenta), secondary (golden), dark (indigo), and state colors. Updated homepage to demonstrate colors on both light and dark backgrounds.
Files: tailwind.config.ts, src/app/page.tsx

=== Issue 1.4: Configurer les fonts ===
Timestamp: 2026-01-17T16:20:00Z
Status: COMPLETED
Commit: 6539a68
Notes: Configured Poppins (headings) and Inter (body) fonts using next/font/google. Added CSS variables and Tailwind fontFamily config. Using display: swap to prevent FOUT.
Files: src/app/layout.tsx, src/app/globals.css, tailwind.config.ts, src/app/page.tsx

=== Issue 1.5: Créer la structure des dossiers ===
Timestamp: 2026-01-17T16:25:00Z
Status: COMPLETED
Commit: 26652f0
Notes: Created complete folder structure with app/game, app/api routes, components (ui, game, layout), hooks, and lib directories. All placeholders created. @/ alias imports verified working.
Files: src/app/game/page.tsx, src/app/api/*, src/components/*, src/hooks/*, src/lib/*

=== Issue 1.6: Configurer les variables d'environnement ===
Timestamp: 2026-01-17T16:30:00Z
Status: COMPLETED
Commit: e8cd85d
Notes: Created .env.local with AUDIO_FOLDER_PATH pointing to test-audio. Updated /api/songs route to use environment variable. Build confirms .env.local is loaded.
Files: .env.local, src/app/api/songs/route.ts

=== Issue 1.7: Configurer ESLint et Prettier ===
Timestamp: 2026-01-17T16:35:00Z
Status: COMPLETED
Commit: b91108a
Notes: Added custom ESLint rules. Created .prettierrc with project settings. Added format script. Ran Prettier on all files.
Files: eslint.config.mjs, .prettierrc, package.json

=== BOOTSTRAP.FEEDBACK: Install Vitest, Husky, lint-staged and configure pre-commit hooks ===
Timestamp: 2026-01-17T17:40:00Z
Status: COMPLETED
Commit: fd32217
Notes: Installed vitest, @vitejs/plugin-react, jsdom, @testing-library/react, husky, and lint-staged. Created vitest.config.ts with jsdom environment and React plugin. Created .husky/pre-commit hook running lint-staged, typecheck, and test. Created .lintstagedrc for Prettier formatting. Added typecheck and test scripts to package.json. Created src/test/setup.ts. All feedback loops verified working.
Files: package.json, vitest.config.ts, .husky/pre-commit, .lintstagedrc, src/test/setup.ts

=== Issue 1.8: Créer le fichier de types global ===
Timestamp: 2026-01-17T17:50:00Z
Status: COMPLETED
Commit: dc08362
Notes: Created complete TypeScript types in src/lib/types.ts. Defined Song, AudioFormat, GameConfig, GuessMode, GameState, GameStatus, ApiResponse, SongsListResponse, RandomSongResponse, and GameAction types. All types exported and usable throughout the project.
Files: src/lib/types.ts

=== Issue 2.1: Installer music-metadata ===
Timestamp: 2026-01-17T18:00:00Z
Status: COMPLETED
Commit: 7c28f25
Notes: Installed music-metadata package (v11.10.6) for reading ID3 tags from audio files. Added import and export in audioScanner.ts to verify the library works. Updated ESLint config to ignore underscore-prefixed unused variables. All feedback loops pass.
Files: package.json, package-lock.json, src/lib/audioScanner.ts, eslint.config.mjs

=== Issue 2.2: Créer le scanner de dossier audio ===
Timestamp: 2026-01-17T17:52:00Z
Status: COMPLETED
Commit: 2c6c289
Notes: Implemented scanAudioFolder function that recursively scans directories for audio files. Supports mp3, wav, ogg, flac, m4a, aac formats. Ignores hidden directories and special folders (@eaDir, __MACOSX). Handles permission errors and non-existent folders gracefully. Added getSupportedExtensions utility. Created comprehensive test suite with 10 passing tests.
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts

=== Issue 2.3: Extraire les métadonnées ID3 ===
Timestamp: 2026-01-17T17:55:00Z
Status: COMPLETED
Commit: 1baa45d
Notes: Implemented extractMetadata function to read ID3 tags from audio files using music-metadata. Added parseFileName helper for fallback on "Artist - Title" filename format. Added generateSongId function for unique 12-char hex IDs based on file path. Extended AudioFormat type to include m4a and aac. Created comprehensive tests for all new functions (22 tests total pass).
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts, src/lib/types.ts

=== Issue 2.4: Extraire les pochettes d'album ===
Timestamp: 2026-01-17T18:00:00Z
Status: COMPLETED
Commit: 47b04c0
Notes: Implemented extractCover function to extract album covers from audio files. First tries embedded covers in ID3 tags, then falls back to cover.jpg/cover.png/folder.jpg/folder.png/album.jpg/album.png in the song's directory. Added getCoverMimeType function to detect MIME type of cover images. Added getCoverFilenames helper. Created 15 comprehensive tests for cover extraction (37 tests total pass).
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts

=== Issue 2.5: Générer des IDs uniques pour les chansons ===
Timestamp: 2026-01-17T18:02:00Z
Status: COMPLETED
Commit: 6214d84
Notes: Validated the generateSongId function implementation (added in issue 2.3). Function uses MD5 hash of file path truncated to 12 hex characters, ensuring deterministic and unique IDs. Same file always generates the same ID, different files generate different IDs. Tests already covered in audioScanner.test.ts (3 tests for generateSongId).
Files: PRD.md (marked complete)


=== Issue 2.6: Créer un cache des métadonnées ===
Timestamp: 2026-01-17T18:05:00Z
Status: COMPLETED
Commit: 08c8b5d
Notes: Implemented in-memory metadata cache with getSongsCache(), refreshCache(), getCacheInfo(), clearCache(), and isCacheInitialized() functions. First call triggers scan, subsequent calls use cache. Created 10 comprehensive tests for cache functionality (47 tests total pass).
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts

=== Issue 2.7: Gérer les fichiers sans métadonnées ===
Timestamp: 2026-01-17T18:08:00Z
Status: COMPLETED
Commit: 2a28105
Notes: Enhanced parseFileName to handle additional filename formats beyond "Artist - Title". Added support for track number prefixes (01 - Title, 1 - Title), track numbers with dots (01. Title), and underscore separators (Artist_Title). Dash format prioritized over underscore. Added 10 new tests for filename parsing edge cases (57 tests total pass).
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts

=== Issue 2.8: Valider les formats audio supportés ===
Timestamp: 2026-01-17T18:12:00Z
Status: COMPLETED
Commit: 6b5a007
Notes: Added format validation functions: isFormatSupported (checks universal browser support), getFormatWarning (returns warnings for OGG/FLAC), getUniversalFormats and getPartialSupportFormats helpers. Documented browser compatibility in JSDoc comments with compatibility table. Created 15 comprehensive tests for format validation (72 tests total pass).
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts

=== Issue 2.9: Gérer les erreurs de lecture ===
Timestamp: 2026-01-17T18:15:00Z
Status: COMPLETED
Commit: 87d5989
Notes: Implemented graceful error handling for audio file reading. Added safeExtractMetadata wrapper function, classifyReadError for error type classification (FILE_NOT_FOUND, PERMISSION_DENIED, CORRUPTED_FILE, UNKNOWN_ERROR), getReadErrorMessage for French user-friendly messages, and batchExtractMetadata for processing multiple files while continuing after errors. Created 17 comprehensive tests for error handling (89 tests total pass).
Files: src/lib/audioScanner.ts, src/lib/audioScanner.test.ts

=== Issue 2.10: Ajouter un endpoint de rafraîchissement du cache ===
Timestamp: 2026-01-17T18:18:00Z
Status: COMPLETED
Commit: 3794ba4
Notes: Created POST /api/songs/rescan endpoint that triggers refreshCache() and returns the song count and last scan timestamp. Endpoint returns success response with songsCount and lastScan, or error response with message if rescan fails. Added 5 comprehensive tests for the endpoint (94 tests total pass).
Files: src/app/api/songs/rescan/route.ts, src/app/api/songs/rescan/route.test.ts

=== Issue 3.1: Créer GET /api/songs ===
Timestamp: 2026-01-17T18:21:00Z
Status: COMPLETED
Commit: 55c2248
Notes: Implemented GET /api/songs endpoint using getSongsCache() from audioScanner. Returns JSON response with songs array and total count. Includes proper error handling with 500 status. Created comprehensive test suite with 5 tests (99 tests total pass).
Files: src/app/api/songs/route.ts, src/app/api/songs/route.test.ts

=== Issue 3.2: Créer GET /api/songs/random ===
Timestamp: 2026-01-17T18:25:00Z
Status: COMPLETED
Commit: a58f422
Notes: Implemented GET /api/songs/random endpoint for selecting random songs. Added support for exclude query parameter to filter out already-played songs. Returns 404 when no songs available or all songs excluded. Created comprehensive test suite with 8 tests including uniform distribution verification (107 tests total pass).
Files: src/app/api/songs/random/route.ts, src/app/api/songs/random/route.test.ts

=== Issue 3.3: Créer GET /api/songs/[id] ===
Timestamp: 2026-01-17T18:30:00Z
Status: COMPLETED
Commit: 854586d
Notes: Implemented GET /api/songs/[id] endpoint to return a specific song by ID. Added ID format validation (12 hex characters). Returns 404 for unknown song IDs, 400 for invalid ID format. Created comprehensive test suite with 8 tests (115 tests total pass).
Files: src/app/api/songs/[id]/route.ts, src/app/api/songs/[id]/route.test.ts

=== Issue 3.4: Créer GET /api/audio/[id] ===
Timestamp: 2026-01-17T18:36:00Z
Status: COMPLETED
Commit: eeda086
Notes: Implemented GET /api/audio/[id] endpoint for streaming audio files. Added Range Request support (HTTP 206) for seeking in audio players. MIME types defined for all supported audio formats (mp3, wav, ogg, flac, m4a, aac). ID validation (12 hex characters). Created comprehensive test suite with 7 tests (122 tests total pass).
Files: src/app/api/audio/[id]/route.ts, src/app/api/audio/[id]/route.test.ts

=== Issue 3.5: Créer GET /api/cover/[id] ===
Timestamp: 2026-01-17T18:41:00Z
Status: COMPLETED
Commit: 9f6b0ab
Notes: Implemented GET /api/cover/[id] endpoint for serving album covers. Returns embedded cover from audio file if available (via extractCover), fallback to cover.jpg/cover.png in song directory, or placeholder SVG if no cover found. Image MIME type detected from magic bytes (JPEG, PNG, GIF, WebP). Cache headers set for 1 year. ID validation (12 hex characters). All 122 tests pass.
Files: src/app/api/cover/[id]/route.ts

=== Issue 3.6: Gérer les Range Requests pour l'audio ===
Timestamp: 2026-01-17T18:44:00Z
Status: COMPLETED
Commit: 873d4f2
Notes: Added comprehensive Range Request test suite with 11 new tests. Tests verify: 206 Partial Content status, Content-Range header format, Accept-Ranges header, start-only ranges (bytes=512-), exact byte ranges, edge cases (first byte, last byte, middle ranges), 416 Range Not Satisfiable for invalid ranges, correct byte content verification for seeking simulation, MIME types for all audio formats. All 133 tests pass.
Files: src/app/api/audio/[id]/route.test.ts

=== Issue 3.7: Ajouter les headers CORS appropriés ===
Timestamp: 2026-01-17T18:45:00Z
Status: COMPLETED
Commit: 9f73a55
Notes: Configured CORS headers in next.config.ts for all API routes. Added Access-Control-Allow-Origin: * for cross-origin requests, Access-Control-Allow-Methods for GET/POST/OPTIONS, Access-Control-Allow-Headers for Content-Type and Range headers, and Access-Control-Expose-Headers for Content-Range and Accept-Ranges to support Range Requests from cross-origin clients. All 133 tests pass.
Files: next.config.ts

=== Issue 3.8: Créer GET /api/stats ===
Timestamp: 2026-01-17T18:48:00Z
Status: COMPLETED
Commit: 8d39e44
Notes: Implemented GET /api/stats endpoint returning library statistics including totalSongs, totalArtists, totalAlbums, totalDuration (rounded integer), totalDurationFormatted (human-readable like "10h 0min"), formats breakdown by type, songsWithCover count, and lastScan timestamp. Created comprehensive test suite with 7 tests. All 140 tests pass.
Files: src/app/api/stats/route.ts, src/app/api/stats/route.test.ts

=== Issue 3.9: Optimiser le streaming audio ===
Timestamp: 2026-01-17T18:52:00Z
Status: COMPLETED
Commit: 7a09bdc
Notes: Optimized audio streaming to use true streaming via Readable.toWeb() instead of buffering the entire file in memory. Added 64KB highWaterMark for optimal chunk sizes. Both Range Requests and full file requests now stream without loading the entire file into memory. Memory stays stable even with large audio files.
Files: src/app/api/audio/[id]/route.ts

=== Issue 3.10: Créer POST /api/songs/rescan ===
Timestamp: 2026-01-17T18:56:00Z
Status: COMPLETED
Commit: b588cbd
Notes: Updated POST /api/songs/rescan endpoint to return scanDuration and human-readable message as per epic specs. Response now includes success, songsFound, scanDuration, and message fields. Added test for scan duration measurement accuracy. All 141 tests pass.
Files: src/app/api/songs/rescan/route.ts, src/app/api/songs/rescan/route.test.ts

=== Issue 4.1: Créer le layout principal ===
Timestamp: 2026-01-17T19:30:00Z
Status: COMPLETED
Commit: d041f24
Notes: Updated layout.tsx with festive gradient background (from-indigo-950 via-purple-900 to-pink-900), min-h-screen flex container structure, and updated SEO metadata. Added CSS font variables for Poppins (headings) and Inter (body), heading font styles, and gradient-shift animation for animated background effect. All 141 tests pass.
Files: src/app/layout.tsx, src/app/globals.css

=== Issue 4.2: Designer la page d'accueil ===
Timestamp: 2026-01-17T19:32:00Z
Status: COMPLETED
Commit: 7329177
Notes: Redesigned homepage with festive gradient title (yellow-pink-purple), descriptive subtitle, and animated bouncing music icons for festive ambiance. Added placeholders for GameConfigForm and LibraryStats components (to be implemented in issues 4.3 and 4.6). Styled "Nouvelle Partie" button with gradient and hover effects. Responsive design with mobile/desktop title sizes. All 141 tests pass.
Files: src/app/page.tsx

=== Issue 4.3: Créer le formulaire de configuration ===
Timestamp: 2026-01-17T19:34:00Z
Status: COMPLETED
Commit: f9b4dc5
Notes: Created GameConfigForm component with useState for guessMode (default 'both'), clipDuration (default 20s), and isLoading. Implemented handleSubmit that builds URLSearchParams and redirects to /game with query params. Styled form with backdrop-blur glass effect and sections for mode selector and duration slider (placeholders for 4.4/4.5). Integrated component in homepage replacing placeholder. All 141 tests pass.
Files: src/components/game/GameConfigForm.tsx, src/app/page.tsx

=== Issue 4.4: Ajouter le sélecteur de mode de devinette ===
Timestamp: 2026-01-17T19:35:00Z
Status: COMPLETED
Commit: c9e1728
Notes: Added guess mode selector with 3 styled radio button options (title, artist, both). Each option shows label and description. Visual selection state with purple border/background highlight. Radio inputs use sr-only class for accessibility while remaining keyboard navigable via labels. All 141 tests pass.
Files: src/components/game/GameConfigForm.tsx

=== Issue 4.5: Ajouter le slider durée des extraits ===
Timestamp: 2026-01-17T19:37:00Z
Status: COMPLETED
Commit: 3b0a30b
Notes: Added range slider for clip duration (5-60 seconds, step 5). Displays current duration value in real-time with large bold text. Styled slider thumb with gradient from pink-500 to purple-500 matching theme. Added min/max labels (5s, 30s, 60s) below the slider. Removed underscore prefix from setClipDuration to enable functionality. All 141 tests pass.
Files: src/components/game/GameConfigForm.tsx

=== Issue 4.6: Afficher le nombre de chansons disponibles ===
Timestamp: 2026-01-17T19:38:00Z
Status: COMPLETED
Commit: c755858
Notes: Created LibraryStats component that fetches stats from /api/stats endpoint. Displays total songs and total artists count from the music library. Shows loading state with animated pulse while fetching data. Handles errors gracefully with user-friendly French error message. Integrated component in homepage replacing placeholder. All 141 tests pass.
Files: src/components/game/LibraryStats.tsx, src/app/page.tsx

=== Issue 4.7: Ajouter la validation du formulaire ===
Timestamp: 2026-01-17T19:41:00Z
Status: COMPLETED
Commit: 11413b7
Notes: Added form validation to GameConfigForm component. Implemented validateForm async function that checks: 1) At least one song exists in the library by fetching /api/songs, 2) Clip duration is within valid range (5-60 seconds). Added validationError state and styled error display with red background. Made handleSubmit async to await validation before redirecting. If validation fails, form submission is blocked and error message is displayed. All 141 tests pass.
Files: src/components/game/GameConfigForm.tsx

=== Issue 4.8: Persister la configuration ===
Timestamp: 2026-01-17T19:45:00Z
Status: COMPLETED
Commit: b48caa3
Notes: Added localStorage persistence for game configuration (guessMode, clipDuration). Created loadSavedConfig helper function to load and validate saved config on mount. Added handleGuessModeChange and handleClipDurationChange callback handlers that save to localStorage immediately on every change. Validates guessMode against valid values and clipDuration against valid range (5-60, step 5). Invalid or corrupted localStorage data is gracefully ignored and defaults are used. All 141 tests pass.
Files: src/components/game/GameConfigForm.tsx

=== Issue 4.9: Ajouter un bouton "Paramètres avancés" ===
Timestamp: 2026-01-17T19:48:00Z
Status: COMPLETED
Commit: fa189a8
Notes: Added collapsible "Paramètres avancés" section with smooth CSS animations. Implemented three advanced options: 1) Timer duration slider (3-30 seconds), 2) No-timer toggle for unlimited response time, 3) Random start point toggle to begin at random position in song. Extended SavedConfig interface and loadSavedConfig validation for all new settings. All settings persisted to localStorage and passed to /game via query params. All 141 tests pass.
Files: src/components/game/GameConfigForm.tsx

=== Issue 4.10: Créer une animation d'entrée ===
Timestamp: 2026-01-17T19:50:00Z
Status: COMPLETED
Commit: 251665e
Notes: Installed framer-motion for smooth page entry animations. Converted homepage to client component with staggered fade-up animations. Title appears first, then music icons, form, and finally stats. Implemented prefers-reduced-motion support via useReducedMotion hook - animations are completely disabled when user has reduced motion preference. No flash of unstyled content. All 141 tests pass.
Files: package.json, package-lock.json, src/app/page.tsx

=== Issue 5.1: Créer la page /game ===
Timestamp: 2026-01-17T19:52:00Z
Status: COMPLETED
Commit: 825fc96
Notes: Created game page with URL parameters parsing (mode, duration, timerDuration, noTimer). Integrated all game components with proper props interfaces: AudioPlayer, BuzzerButton, Timer, ScoreDisplay, SongReveal, GameControls. Added Suspense wrapper for useSearchParams. Updated useGameState hook to return proper state/actions interface for game logic. Responsive flex layout structure. All 141 tests pass.
Files: src/app/game/page.tsx, src/components/game/GameControls.tsx, src/components/game/AudioPlayer.tsx, src/components/game/BuzzerButton.tsx, src/components/game/Timer.tsx, src/components/game/ScoreDisplay.tsx, src/components/game/SongReveal.tsx, src/hooks/useGameState.ts

=== Issue 5.2: Implémenter le layout de jeu ===
Timestamp: 2026-01-17T19:55:00Z
Status: COMPLETED
Commit: 64473f0
Notes: Implemented responsive game layout with mobile-first design. Mobile layout: vertical stack with header at top, central zone (cover+audio bar), buzzer/timer, and controls at bottom. Desktop layout (lg+): two-column layout with cover/audio on left side and controls/buzzer/timer on right side (fixed 320px width). Used Tailwind lg: breakpoint for smooth transitions between layouts. Improved quit button styling with hover background effect. All 141 tests pass.
Files: src/app/game/page.tsx

=== Issue 5.3: Créer le composant AudioPlayer ===
Timestamp: 2026-01-17T19:57:00Z
Status: COMPLETED
Commit: 4ad0ad8
Notes: Implemented full HTML5 audio player component. Audio loads from /api/audio/{songId} endpoint. Play/pause controlled via isPlaying prop with effects. Visual progress bar with gradient (pink to purple). Auto-stop playback when currentTime reaches maxDuration and calls onEnded callback. Uses onLoadStart event to reset state when new song loads, avoiding ESLint set-state-in-effect warning. Time display in mm:ss format. All 141 tests pass.
Files: src/components/game/AudioPlayer.tsx

